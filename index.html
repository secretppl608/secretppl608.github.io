  <!DOCTYPE html>
 <html lang="zh-CN">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>客服订单信息生成工具</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="./lib/css/index.css">
 </head>
 <body>
     <div class="container">
         <header>
           <a href="https://secretppl608.github.io/find.html"
   target="_blank"
   rel="noopener noreferrer"
   class="query-link"
   aria-label="在新窗口打开查询系统">
   查询系统由此去→
           </a>
             <h1>订单信息创建系统</h1>
             <p class="subtitle">惊殊网游数娱</p>
         </header>
         <!-- 一级选项（多选） -->
<div class="input-group">
<label class="highlight">替身卡装扮不补差价，生日气氛组和跑图/小金人单子带人不减半！<br>返图前三张免费，老板多要的按0.1r/张补差。<br>低价改高价要求需要补差额，高价要求改低价要求不退差额，比如普陪15分钟是3.1，病恋15分钟是7.8，那么需要补7.8-3.1=4.7r差价，原价在订单管理可以查到，新价在邀请下单可以查到，注意这里的减数和被减数都是原价，不是折扣价！</label>
     <label>补差价类目，商品时长、商品数量<br>还需补差价<span class="highlight" id="difpriceOuter">¥0.00</span>！</label>
     <select id="difpriceEnter" multiple class="form-control" style="width:30%;">
         <!-- 固定价格服务 -->
         <option value="fixed_service1">指定装扮</option>
         <option value="fixed_service2">指定人</option>
         <option value="fixed_service3">指定技能</option>
         <option value="fixed_service4">开麦</option>
<option value="fixed_service5">送糖/打赏/其他补差</option>  <!-- 按时收费服务 -->
         <option value="time_service1">hw</option>
         <option value="time_service2">小勾文学</option>
         <option value="time_service3">小圈(BDSM)</option>
         <option value="time_service4">单口特殊技能</option>
         <option value="time_service5">高压虐/病</option>
         <option value="time_service6">疯虐/病</option>
         <option value="time_service7">国际服</option>
         <option value="time_service8">续单</option>
         <option value="night_subsidy">夜间补贴</option>
     </select>
     <select id="difpriceTimeEnter" class="form-control" style="width:30%;">

         <option value="15">15分钟</option>
         <option value="30+5">30+5分钟</option>
         <option value="60+15">60+15分钟</option>
         <option value="120+30">120+30分钟</option>

     </select>

<input type="number" min="1" step="1" max="50" value="1" placeholder="数量" style="width:30%;" id="number" required>
</div>
         <div class="input-group">
             <label for="dhenter">粘贴订单号：</label>
             <textarea id="dhenter" placeholder="在此处粘贴订单号..."></textarea>
         </div>

                        <div class="input-group">
             <label>请选择游戏及客服：</label>
                  <select id="yxenter" class="form-control">
<option value="S">光遇---牵手</option><option value="T">光遇---代肝</option><option value="C">超自然行动组</option>
</select>
<select id="kfenter" class="form-control">
<option value="Z">鸭蛋</option>
<option value="Y">素锦</option><option value="U">失忆</option><option value="A">楚曦</option><option value="B">砚冰</option><option value="C">大马猴</option><option value="D">轻</option><option value="E">宵夜</option><option value="F">江月</option><option value="G">沈烬</option><option value="H">昭昭</option><option value="I">悸槐安</option><option value="J">问</option><option value="K">桐</option>
</select>
                        </div>
<div class="input-group">
             <label for="enter">粘贴规格信息：</label>
             <textarea id="skuenter" placeholder="在此处粘贴sku规格信息，该字段不得填写其他内容，只能填充千牛后台生成的sku信息，例如“款式描述:病.虐./抽.象.病.虐.;大小:60赠15min”，缺失时长信息的，默认15min..."></textarea>
         </div>

         <div class="input-group">
             <label for="enter">粘贴物流信息：</label>
             <textarea id="enter" placeholder="在此处粘贴物流信息，操作路径：订单管理（待发货）->每个订单右下角查看物流->复制全部物流信息->粘粘至此处..."></textarea>
         </div>
<div class="input-group">
             <label for="yqenter">填写其他信息：</label>
             <textarea id="yqenter" placeholder="在此处填写邀请码/要求信息，及对sku信息的补充，不得将系统sku粘粘至此字段..."></textarea>
         </div>
         
         <div class="order-info-container">
             <div class="order-info-title">订单信息：</div>
             <div class="order-info-item">惊殊：编号：<span id="ysouter" class="highlight">编号</span></div>
<div class="order-info-item">订单号：<span id="dhouter" class="highlight">等待输入</span></div>
             <div class="order-info-item">游戏名：<span id="yxouter" class="highlight">等待输入</span></div>
             <div class="order-info-item">sku规格：<span id="skuouter" class="highlight">等待输入</span></div>
             <div class="order-info-item">创建时间：<span id="outer" class="highlight">未找到下单时间</span></div>
             <div class="order-info-item">店铺：<span class="highlight">惊殊网游数娱</span></div>
             <div class="order-info-item"><span id="yqouter"></span><span id="pmouter"></span></div>
         </div>
         <!--
         <div class="copy-btn-container">
             <button id="copyOrderBtn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                     <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                 </svg>
                 复制订单信息
             </button>
         </div>
-->
 <div class="s-button-container">
            <button class="s-btn save-btn" id="saveButton">
                <i class="fas fa-save"></i>
                <span class="text">复制并保存</span>
            </button>
             </div>   
             </div>   
   <script>
            // 获取所有DOM元素
const p = document.getElementById('outer');
const logisticsInfo = document.getElementById('enter');
const dhenter = document.getElementById('dhenter');
const dhouter = document.getElementById('dhouter');
const ysouter = document.getElementById('ysouter');
const yxenter = document.getElementById('yxenter');
const yxouter = document.getElementById('yxouter');
const kfenter = document.getElementById('kfenter');
const skuenter = document.getElementById('skuenter');
const skuouter = document.getElementById('skuouter');
const yqenter = document.getElementById('yqenter');
const yqouter = document.getElementById('yqouter');
const number = document.getElementById('number');
const copyButton = document.getElementById('copyOrderBtn');
const pmouter = document.getElementById('pmouter');
const difpriceouter = document.getElementById('difpriceOuter');
const difpriceEnter = document.getElementById('difpriceEnter');
const difpriceTimeEnter = document.getElementById('difpriceTimeEnter');

// 服务价格配置
const servicePrices = {
    fixed_service1: 2.00,
    fixed_service2: 2.00,
    fixed_service3: 3.00,
    fixed_service4: 2.00,
    fixed_service5: 0.01,
    night_subsidy: {
        '15': 0.50,
        '30+5': 1.00,
        '60+15': 2.00,
        '120+30': 4.00
    },
    time_service1: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service2: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service3: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service4: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service5: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service6: {
        '15': 2.00,
        '30+5': 4.00,
        '60+15': 6.00,
        '120+30': 8.00
    },
    time_service7: {
        '15': 1.00,
        '30+5': 3.00,
        '60+15': 5.00,
        '120+30': 7.00
    },
    time_service8: {
        '15': 3.00,
        '30+5': 3.00,
        '60+15': 4.50,
        '120+30': 7.50
    }
};

// 单号更新函数
function updateOrderNumber() {
    dhouter.textContent = dhenter.value || "等待输入";
}

function updateOrderCode() {
    // 定义字符集（0-9, A-Z）
    const charset = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    
    if (!dhenter.value) {
        ysouter.textContent = "等待输入";
        return;
    }
    
    try {
        const bigIntOrder = BigInt(dhenter.value);
        const remainder = Number(bigIntOrder % 46656n);
        
        // 计算36进制表示的三个位
        const high = Math.floor(remainder / 1296);
        const mid = Math.floor((remainder % 1296) / 36);
        const low = remainder % 36;
        
        // 组合成三位代码
        const orderCode = charset[high] + charset[mid] + charset[low];
        ysouter.textContent = (kfenter.value || "") + (yxenter.value || "") + orderCode;
    } catch (e) {
        ysouter.textContent = "单号格式错误";
        console.error("订单号处理错误:", e);
    }
}

// 物流时间解析函数
function updateLogisticsTime() {
    const text = logisticsInfo.value;
    const pattern = /已下单[\s\S]*?(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})[\s\S]*?商品已经下单/m;
    const match = text.match(pattern);
    const realTime = getCurrentDateTime();
    p.textContent = match ? match[1] : realTime;
    p.className = match ? "highlight" : "";
}

function updateGame() {
    yxouter.textContent = yxenter.options[yxenter.selectedIndex].text;
}

function updateSku() {
    skuouter.textContent = (skuenter.value || "") + (yxenter.value=='S'?difpriceTimeEnter.value+"min":"") + (number.value ? "×" + number.value : "");
}

// 更新疫情备注函数 - 修复版
function updateYq() {
    const pmText = updatePriceAndFee(); // 获取价格更新后的文本
    yqouter.textContent = yqenter.value
        ? (pmText ? `${yqenter.value}，` : yqenter.value)
        : "";
}

// 自动选择夜间补贴
function autoSelectNightSubsidy() {
    const now = new Date();
    const hours = now.getHours();
    const nightOption = document.querySelector('#difpriceEnter option[value="night_subsidy"]');
    
    if (hours >= 1 && hours < 6) {
        if (!nightOption.selected) nightOption.selected = true;
    } else {
        if (nightOption.selected) nightOption.selected = false;
    }
}

// 差价系统计算
function difPriceSystem() {
    autoSelectNightSubsidy();
    
    const selectedServices = Array.from(difpriceEnter.selectedOptions).map(opt => opt.value);
    const selectedTime = difpriceTimeEnter.value;
    
    let allPriceSum = 0.00;
    
    selectedServices.forEach(serviceId => {
        const priceInfo = servicePrices[serviceId];
        
        if (typeof priceInfo === 'number') {
            allPriceSum += priceInfo;
        } else if (typeof priceInfo === 'object' && priceInfo[selectedTime] !== undefined) {
            allPriceSum += priceInfo[selectedTime];
        }
    });
    
    return allPriceSum.toFixed(2);
}

// 统一的价格和跑单费更新函数
function updatePriceAndFee() {
    const total = parseFloat(difPriceSystem()) * parseFloat(number.value || 1);
    const pm = parseFloat((total * 0.5).toFixed(2));
    
    difpriceouter.textContent = "¥" + total.toFixed(2);
    
    const selectedOptions = Array.from(difpriceEnter.selectedOptions);
    const selectedValues = selectedOptions.map(option => option.textContent);
    const result = selectedValues.join(', ');
    
    const pmText = pm > 0 ? `${result}+${pm}` : result;
    pmouter.textContent = pmText;
    
    return pmText;
}
     // 复制订单信息功能
function copyOrderInfo() {
  // ...前面的代码不变...
  const infoLines = [
        `惊殊：编号：${ysouter.textContent}`,
        `订单号：${dhouter.textContent}`,
        `游戏名：${yxouter.textContent}`,
        `sku规格：${skuouter.textContent}`,
        `创建时间：${p.textContent}`,
        `店铺：惊殊网游数娱`,
`${yqouter.textContent}${pmouter.textContent}`
    ];
    
    const infoText = infoLines.join('\n');
    
    // 创建临时textarea进行复制
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = infoText;
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      // 克隆原始SVG并修改（保留原始尺寸）
      /* const originalSvg = copyButton.querySelector('svg').cloneNode(true);
      originalSvg.innerHTML = `<polyline points="20 6 9 17 4 12"></polyline>`;
      
      // 只替换文本内容，保留SVG结构
      copyButton.innerHTML = '';
      copyButton.appendChild(originalSvg);
      copyButton.appendChild(document.createTextNode('已复制'));
copyButton.classList.add('copied', 'copied-animation');
     
      // 2秒后恢复
      setTimeout(() => {
        copyButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          复制订单信息
        `;
        copyButton.classList.remove('copied', 'copied-animation');
      }, 2000);
*/
    }
  } catch (err) {
console.error('复制失败:', err);
        alert('复制失败，请手动复制文本。');
  }
 document.body.removeChild(tempTextArea);
}
     function getCurrentDateTime() {
  const now = new Date();

  // 获取日期和时间组件
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0'); // 月份从0开始，需+1
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');

  // 组合成目标格式
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
     }
     
// 初始化所有功能
function initSystem() {
    // 绑定事件监听
    dhenter.addEventListener('input', function(event){
updateOrderNumber();
updateOrderCode();
});
    logisticsInfo.addEventListener('input', updateLogisticsTime);
  // 使用事件委托统一处理所有表单元素的 input 和 change 事件
document.addEventListener('input', handleFormEvent);
document.addEventListener('change', handleFormEvent);

let debounceTimer;
function handleFormEvent(event) {
  if (!event.target.matches('input, select, textarea')) return;
  
  // 500ms防抖
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(updateLogisticsTime, 500);
     }
  
    yxenter.addEventListener('change', updateGame);
    yxenter.addEventListener('change',function(event){
      updateOrderCode();
       updateSku();
});
    kfenter.addEventListener('input', updateOrderCode);
    skuenter.addEventListener('input', updateSku);
    yqenter.addEventListener('input', updateYq);
    
    number.addEventListener('input', function(event) {
        updateSku();
        updatePriceAndFee();
    });
    
   /* copyButton.addEventListener('click', copyOrderInfo); */
    
    // 差价系统事件监听
    difpriceEnter.addEventListener('change', function(event) {
        updatePriceAndFee();
        updateYq();
    });
    
    difpriceTimeEnter.addEventListener('change', function(event) {
        updatePriceAndFee();
        updateYq();
        updateSku();
    });
    
    // 初始化显示
    updateOrderNumber();
    updateLogisticsTime();
    updateOrderCode();
    updateGame();
    updateSku();
    updatePriceAndFee(); // 初始化价格系统
    updateYq();
  getCurrentDateTime();
}

// 确保DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', initSystem);

const saveButton = document.getElementById('saveButton');
        
        saveButton.addEventListener('click', function() {
            // 切换到保存中状态
            this.classList.remove('saved');
            this.classList.add('saving');
            
            // 模拟保存过程（2秒）
            setTimeout(() => {
                // 切换到已保存状态
                this.classList.remove('saving');
                this.classList.add('saved');
                
                // 3秒后恢复原始状态
                setTimeout(() => {
                    this.classList.remove('saved');
                }, 3000);
            }, 2000);
});

// 替换为你的Supabase项目URL和公钥
document.addEventListener('DOMContentLoaded', function() {
            // 初始化Supabase
            const supabaseUrl = 'https://qccrhtfficbcjkzvgfvq.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjY3JodGZmaWNiY2prenZnZnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5Njk5MTAsImV4cCI6MjA2OTU0NTkxMH0.UXqa7RsC38lfiDMvdC9DpWq7F1ZduqE3wBcTRFaht1o';
            
            // 使用全局的supabase对象来创建客户端
            window.supabase = supabase.createClient(supabaseUrl, supabaseKey);

if (!window.supabase) {
                console.error('Supabase未初始化');
                return;
            }
});            
async function addOrder(){
    const order = {
        order_code: ysouter.textContent,
        order_sigh: dhouter.textContent,
        order_game: yxouter.textContent,
        order_sku: skuouter.textContent,
        order_createTime:p.textContent,
        order_request:yqouter.textContent,
        order_pmouter:pmouter.textContent
    };
    try {
        const {data, error} = await window.supabase
        .from('js_order_info')
        .insert([order]);
        if (error) throw error;
        
        console.log('添加订单成功:', data);
        alert('保存复制成功！');
    } catch (error) {
        console.error('添加订单失败:', error);
        alert('保存失败: ' + error.message);
    }
}

saveButton.addEventListener('click', addOrder);
saveButton.addEventListener('click', copyOrderInfo);
    </script>
</body>
</html>
